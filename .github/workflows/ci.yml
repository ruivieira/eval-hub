name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-checks:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Install dependencies
      run: make install-deps

    - name: Format check
      run: |
        make fmt
        git diff --exit-code || (echo "Code is not formatted. Run 'make fmt' locally." && exit 1)

    - name: Run linter
      run: make lint

    - name: Run vet
      run: make vet

    - name: Run unit tests with coverage
      run: |
        make test-all-coverage
        go tool cover -func=bin/coverage.out -o=bin/coverage.txt
        go tool cover -func=bin/coverage-fvt.out -o=bin/coverage-fvt.txt

    - name: Run FVT tests
      run: make test-fvt

    - name: Upload coverage reports to Codecov
      continue-on-error: ${{ github.actor == 'dependabot[bot]' }}  # Don't fail CI on Dependabot PRs since they can't access secrets
      uses: codecov/codecov-action@v5
      with:
        files: ./bin/coverage.out,./bin/coverage-fvt.out
        disable_search: true
        fail_ci_if_error: true
        token: ${{ secrets.CODECOV_TOKEN }}

  security-scan:
    name: Gosec Security Scanner
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: "go.mod"

    - name: Run Gosec Security Scanner
      uses: securego/gosec@v2.19.0
      with:
        args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

    - name: Upload SARIF file to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: gosec-results.sarif
        category: "gosec-security-scan"

    - name: Upload Gosec results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gosec-results
        path: gosec-results.sarif

  docker-build:
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t eval-hub:${{ github.sha }} -f Containerfile .

    - name: Test Docker image
      run: |
        docker run --rm eval-hub:${{ github.sha }} /app/eval-hub --help
